# 仕様書

## 使い方
実行ファイルにNCプログラムの書かれたテキストファイルをD＆Dする。  
もしくはシェルから第一引数にNCプログラムの書かれたテキストファイルを与えて呼び出す。

## 前書き

とりあえずFANUCの旋盤系向けに作る。

半角空白は無視する。  
()内はコメントとし、無視する。  
移動にかかわる準備機能(G0,1,2,3,90,91)以外の準備機能のある行は無視する。  
オプショナルスキップのあるブロックは無視する。  

## 予約語

独自の変数を定義することはできないので予約語というのが正しいか微妙。  
アルファベット1文字+数値は変数扱いする。これらも予約語扱いする。  
それ以外の複数文字連なったアルファベットは、下記の予約語以外エラーとする。  
記号は%()[].+-*/=を予定している。 <!--*-->

独自マクロを実装する場合は予約語に追加で登録し実装する。


工作機械の回転軸中心や、初期の送り速度、オプショナルスキップボタン、オプショナルストップボタンなどは、  
外部ファイルに設定することとする。(ただし未実装。)

### 実装予定予約語

| 実装 | 語    | 内容                                                                                                                                      |
| ---  | ---   | ---                                                                                                                                       |
| 〇   | %     | プログラムの区切り 何もしない。メモリリセットかけてもいいかも。それはやってない。                                                         |
| 〇   | (     | コメントの開始 ()の中は改行以外無視する。改行はCSV一行出力する。                                                                          |
| 〇   | )     | コメントの終了                                                                                                                            |
| 〇   | /     | オプショナルスキップブロック オプショナルスキップブロックのフラグが立っていたらスキップする。外部ファイルは未実装だが機能は実装している。 |
| 〇   | /数値 | 上に同じ。                                                                                                                                |
| 〇   | EOF   | ファイルの途中で解析終了したいときのために実装。
| ×   | GOTO  | 行を移動する。                                                                                                                            |
| ×   | IF    | 条件分岐                                                                                                                                  |
| ×   | THEN  | IFで使う。                                                                                                                                |
| ×   | WHILE | 繰り返し                                                                                                                                  |
| ×   | DO    | WHILEでつかう。                                                                                                                           |
| ×   | EQ    | ==。 IFやWHILEで使う。                                                                                                                    |
| ×   | NE    | !=。IFやWHILEで使う。                                                                                                                     |
| ×   | LT    | <。IFやWHILEで使う。                                                                                                                      |
| ×   | GT    | >。IFやWHILEで使う。                                                                                                                      |
| ×   | LE    | <=。IFやWHILEで使う。                                                                                                                     |
| ×   | GE    | >=。IFやWHILEで使う。                                                                                                                     |
| ×   | AND   | 論理積。IFやWHILEで使う。                                                                                                                 |
| ×   | OR    | 論理和。IFやWHILEで使う。                                                                                                                 |
| ×   | XOR   | 排他的論理和。IFやWHILEで使う。                                                                                                           |
| ×   | [     | IFやWHILEで使う。                                                                                                                         |
| ×   | ]     | IFやWHILEで使う。                                                                                                                         |
| ×   | +     | 数値の正負の表現のほかに四則演算に使う。                                                                                                  |
| ×   | -     | 数値の正負の表現のほかに四則演算に使う。                                                                                                  |
| ×   | *     | 四則演算に使う。                                                                                                                          |
| ×   | /     | オプショナルスキップのほかに四則演算に使う。                                                                                              |
| ×   | =     | 変数への代入に使う。                                                                                                                      |


|      |     |      |       |      |      |
| ---  | --- | ---  | ---   | ---  | ---  |
| GOTO | IF  | THEN | WHILE | END  | ADD  |
| SUB  | MUL | DIV  | EQ    | NE   | LT   |
| LE   | GT  | GE   | AND   | OR   | XOR  |
| SIN  | COS | TAN  | ASIN  | ACOS | ATAN |
| +    | -   | *    | /     | =    | %    |
| (    | )   | [    | ]     | #    |      |
| A    | B   | C    | D     | E    | F    |
| G    | H   | I    | J     | K    | L    |
| M    | N   | O    | P     | Q    | R    |
| S    | T   | U    | V     | W    | X    |
| Y    | Z   |      |       |      | EOF  |


## 変数
おおむね実装している。  

変数宣言が認められていない。このため用意されている領域を使いまわすという意味ではレジスタに近い。  
変数として使える1つ10進8桁の領域が1000個くらいあって、そこを使っていく感じになる。  
アクセスの仕方は#数字である。  
また、#1から#33まではアルファベットでもアクセスできる。(ということにしている...)  
`A1.0`というNCが来るとAが1扱いされて#1に1.0が代入される。  
現状はこうしている。  
これが嫌なら別でメモリ領域を作るようにする必要がある。  
IJKによるものはかなり特殊なので基本的に実装していない。  

### 代入
実装している。

X1.0、X#10 と #10=1.0 の2パターンある。  
\#への代入が面倒で、#だけでは代入なのか参照なのかわからない。  
前処理で変数代入の場合letを先に入れる処理をする。  

## 前処理

内部的に改行コードをLFに統一している。

## 定数

NCの数字は割と特殊な感じなので扱いが面倒。  
工作機械上では基本的に10進8桁までとなっている。  
01.1のように先頭に0がついてもよい。  

また、小数点の扱いが特別で、1と1.は別のものとして扱う。  
1と0001は同じで、1.と1.0、00001.00000は同じ。  
整数の座標値は機械ごとに決められている最小単位の定数倍として扱われる。  
実装としてはとりあえずISCの機械だとみなして定数倍して小数値で保存している。  

## IO

### 入力
NCデータの記述されたテキストファイル

基本UTF-8(no BOM)とする。
ただ基本的に元がテープなのでアスキー文字しか来ないはず。  
改行コードはCR,LF,CR+LFどれであっても問題ないが内部的にLFになる。

### 出力
各座標の座標値、送り速度、などが記述された
csvファイルの予定

内容は拡張していく。

現状入力NCファイルの名前に`.csv`をつけたファイルに出力する。  
もしそのファイルが何らかの原因で開けない場合、入力NCファイルの名前に`_現在時刻.csv`をつけたファイルに出力する。

また標準出力、標準エラー出力にはログが出力されている。

## その他

以下redmineのコピペ

A. Okada が[2019/12/11 10:31]に更新

nc プログラム (通称 G code)
* テキストデータである。
* 文字コード : 規定無し (とりあえず UTF8 で、今後必要なら切り替え可にする)
* テキスト 1 行ごとに、1 回のまとまった動作を表す

※ 固有名詞を、通称 → 厳密な用語に書き換える可能性有

* 最初の行は % である。
* 2番目の行は OXXXX (XXXX は整数) プログラム番号で、プログラムの id 番号のようなものである。
* 以降の行は "ブロック" の集まりが書いてある。
* 最後の行は % である。

厳密に従わないプログラムもあるので、
* % は無視 (指令無し扱い)
* OXXXX は見つけた時点でプログラム番号扱い (=解析上無視してよい)
でもよい

ブロック
* NCプログラムは複数の指令で構成される。1個の指令をブロックという。
* ブロックは EOB コードで区切られる。制御装置上は ; で表示される。
* CAM の nc プログラム出力する場合は、EOB コードは改行文字である。

ブロックの構成
	アドレス = アルファベット1文字 ※特殊設定では存在するが通常は無視でよい
	ワード = アドレス + (スペースはさむ場合有) + 数値
	ブロック = {ワード}* (スペースはさむ場合有)
	ブロックが無い行はなにもしない
