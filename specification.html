<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta http-equiv="refresh" content="9; URL=">
<style type="text/css"><!--

/* build in css*/
body{font-family:Helvetica,arial,sans-serif;font-size:14px;line-height:1.8;padding:30px;background-color:#fff;color:#333}body>:first-child{margin-top:0!important}body>:last-child{margin-bottom:0!important}a{color:#4183c4;text-decoration:none}a.absent{color:#c00}a.anchor{display:block;padding-left:30px;margin-left:-30px;cursor:pointer;position:absolute;top:0;left:0;bottom:0x}h1,h2,h3,h4,h5,h6{margin:20px 0 10px;padding:0;font-weight:700;-webkit-font-smoothing:antialiased;cursor:text;position:relative}h1:first-child,h1:first-child+h2,h2:first-child,h3:first-child,h4:first-child,h5:first-child,h6:first-child{margin-top:0;padding-top:0}h1:hover a.anchor,h2:hover a.anchor,h3:hover a.anchor,h4:hover a.anchor,h5:hover a.anchor,h6:hover a.anchor{text-decoration:none}h1 code,h1 tt,h2 code,h2 tt,h3 code,h3 tt,h4 code,h4 tt,h5 code,h5 tt,h6 code,h6 tt{font-size:inherit}h1{font-size:34px;margin-bottom:40px;padding-bottom:0}h1,h2{color:#000}h2{font-size:30px;border-bottom:2px solid #ccc}h3{font-size:24px;border-bottom:1px solid #ddd}h4{font-size:20px}h5{font-size:18px}h6{font-size:16px;color:#777}blockquote,dl,li,ol,p,pre,table,ul{margin:10px 0}hr{border:0 0 0;height:4px;padding:0}a:first-child h1,a:first-child h2,a:first-child h3,a:first-child h4,a:first-child h5,a:first-child h6,bo dy>h5:first-child,body>h1:first-child,body>h1:first-child+h2,body>h2:first-child,body>h3:first-child,body>h4:first-child,body>h6:first-child{margin-top:0;padding-top:0}h1 p,h2 p,h3 p,h4 p,h5 p,h6 p{margin-top:0}li p.first{display:inline-block}ol,ul{padding-left:30px}ol:first-child,ul:first-child{margin-top:0}dl,dl dt{padding:0}dl dt{font-size:14px;font-weight:700;font-weight:1400;font-style:italic;margin:15px 0 5px}dl dt:first-child{padding:0}dl dt>:first-child{margin-top:0}dl dt>:last-child{margin-bottom:0}dl dd{margin:0 0 15px;padding:0 15px}dl dd>:first-child{margin-top:0}dl dd>:last-child{margin-bottom:0}blockquote{border-left:4px solid #ddd;padding:0 15px;color:#777}blockquote>:first-child{margin-top:0}blockquote>:last-child{margin-bottom:0}table{padding:0;border-spacing:2px;border-collapse:collapse;width:80%;margin:auto}table,td,th{border:1px solid #ccc}td,th{padding:0;margin:0}table tr{background-color:#fff;border-top:1px solid #c6cbd1;margin:0;padding:0}table tr:nth-child(2n){background-color:#f6f8fa}table tr th{font-weight:700}table tr td,table tr th{border:1px solid #ccc;margin:0;padding:6px 13px}table tr td:first-child,table tr th:first-child{margin-top:0}img{max-width:100%}code,tt{margin:0 2px;padding:0 5px;white-space:nowrap;border:1px solid #eaeaea;background-color:#f8f8f8;border-radius:3px}pre code{margin:0;padding:0;white-space:pre;border:0;background:0 0}.highlight pre,pre{border:1px solid #ccc;font-size:13px;line-height:19px;overflow:auto;padding:6px 10px;border-radius:3px}pre code,pre tt{background-color:transparent;border:0}.main-content{max-width:50pc;margin:auto;padding-bottom:50px}hr{border:0!important;color:#fff;height:4px}.page_num{border:0;position:absolute;right:10;bottom:10}
--></style>

<script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']]
  }
};
</script>

<!-- オンラインの時 -->
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script>

<!-- オフラインの時 -->
<script id="MathJax-script" async src="MathJax-3.0.0/es5/tex-mml-chtml.js"></script>


</head>
<body>
<h1 id="仕様書">仕様書</h1>

<p>とりあえずFANUCの旋盤系向けに作る。</p>

<p>半角空白は無視する。
()内はコメントとし、無視する。
移動にかかわる準備機能(G0,1,2,3,90,91)以外の準備機能のある行は無視する。
オプショナルスキップのあるブロックは無視する。</p>

<h2 id="予約語">予約語</h2>

<p>独自の変数を定義することはできないので予約語というのが正しいか微妙。
アルファベット1文字+数値は変数扱いする。これらも予約語扱いする。
それ以外の複数文字連なったアルファベットは、下記の予約語以外エラーとする。
記号は%()[].+-<em>/=を予定している。 &lt;!&ndash;</em>&ndash;&gt;</p>

<p>独自マクロを実装する場合は予約語に追加で登録し実装する。</p>

<p>工作機械の回転軸中心や、初期の送り速度、オプショナルスキップボタン、オプショナルストップボタンなどは、
外部ファイルに設定することとする。(ただし未実装。)</p>

<h3 id="実装予定予約語">実装予定予約語</h3>

<table>
<thead>
<tr>
<th>実装</th>
<th>語</th>
<th>内容</th>
</tr>
</thead>

<tbody>
<tr>
<td>〇</td>
<td>%</td>
<td>プログラムの区切り 何もしない。メモリリセットかけてもいいかも。それはやってない。</td>
</tr>

<tr>
<td>〇</td>
<td>(</td>
<td>コメントの開始 ()の中は改行以外無視する。改行はCSV一行出力する。</td>
</tr>

<tr>
<td>〇</td>
<td>)</td>
<td>コメントの終了</td>
</tr>

<tr>
<td>〇</td>
<td>/</td>
<td>オプショナルスキップブロック オプショナルスキップブロックのフラグが立っていたらスキップする。外部ファイルは未実装だが機能は実装している。</td>
</tr>

<tr>
<td>〇</td>
<td>/数値</td>
<td>上に同じ。</td>
</tr>

<tr>
<td>×</td>
<td>GOTO</td>
<td>行を移動する。</td>
</tr>

<tr>
<td>×</td>
<td>IF</td>
<td>条件分岐</td>
</tr>

<tr>
<td>×</td>
<td>THEN</td>
<td>IFで使う。</td>
</tr>

<tr>
<td>×</td>
<td>WHILE</td>
<td>繰り返し</td>
</tr>

<tr>
<td>×</td>
<td>DO</td>
<td>WHILEでつかう。</td>
</tr>

<tr>
<td>×</td>
<td>EQ</td>
<td>==。 IFやWHILEで使う。</td>
</tr>

<tr>
<td>×</td>
<td>NE</td>
<td>!=。IFやWHILEで使う。</td>
</tr>

<tr>
<td>×</td>
<td>LT</td>
<td>&lt;。IFやWHILEで使う。</td>
</tr>

<tr>
<td>×</td>
<td>GT</td>
<td>&gt;。IFやWHILEで使う。</td>
</tr>

<tr>
<td>×</td>
<td>LE</td>
<td>&lt;=。IFやWHILEで使う。</td>
</tr>

<tr>
<td>×</td>
<td>GE</td>
<td>&gt;=。IFやWHILEで使う。</td>
</tr>

<tr>
<td>×</td>
<td>AND</td>
<td>論理積。IFやWHILEで使う。</td>
</tr>

<tr>
<td>×</td>
<td>OR</td>
<td>論理和。IFやWHILEで使う。</td>
</tr>

<tr>
<td>×</td>
<td>XOR</td>
<td>排他的論理和。IFやWHILEで使う。</td>
</tr>

<tr>
<td>×</td>
<td>[</td>
<td>IFやWHILEで使う。</td>
</tr>

<tr>
<td>×</td>
<td>]</td>
<td>IFやWHILEで使う。</td>
</tr>

<tr>
<td>×</td>
<td>+</td>
<td>数値の正負の表現のほかに四則演算に使う。</td>
</tr>

<tr>
<td>×</td>
<td>-</td>
<td>数値の正負の表現のほかに四則演算に使う。</td>
</tr>

<tr>
<td>×</td>
<td>*</td>
<td>四則演算に使う。</td>
</tr>

<tr>
<td>×</td>
<td>/</td>
<td>オプショナルスキップのほかに四則演算に使う。</td>
</tr>

<tr>
<td>×</td>
<td>=</td>
<td>変数への代入に使う。</td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>

<tbody>
<tr>
<td>GOTO</td>
<td>IF</td>
<td>THEN</td>
<td>WHILE</td>
<td>END</td>
<td>ADD</td>
</tr>

<tr>
<td>SUB</td>
<td>MUL</td>
<td>DIV</td>
<td>EQ</td>
<td>NE</td>
<td>LT</td>
</tr>

<tr>
<td>LE</td>
<td>GT</td>
<td>GE</td>
<td>AND</td>
<td>OR</td>
<td>XOR</td>
</tr>

<tr>
<td>SIN</td>
<td>COS</td>
<td>TAN</td>
<td>ASIN</td>
<td>ACOS</td>
<td>ATAN</td>
</tr>

<tr>
<td>+</td>
<td>-</td>
<td>*</td>
<td>/</td>
<td>=</td>
<td>%</td>
</tr>

<tr>
<td>(</td>
<td>)</td>
<td>[</td>
<td>]</td>
<td>#</td>
<td></td>
</tr>

<tr>
<td>A</td>
<td>B</td>
<td>C</td>
<td>D</td>
<td>E</td>
<td>F</td>
</tr>

<tr>
<td>G</td>
<td>H</td>
<td>I</td>
<td>J</td>
<td>K</td>
<td>L</td>
</tr>

<tr>
<td>M</td>
<td>N</td>
<td>O</td>
<td>P</td>
<td>Q</td>
<td>R</td>
</tr>

<tr>
<td>S</td>
<td>T</td>
<td>U</td>
<td>V</td>
<td>W</td>
<td>X</td>
</tr>

<tr>
<td>Y</td>
<td>Z</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h2 id="変数">変数</h2>

<p>変数宣言が認められていない。
このため用意されている領域を使いまわすという意味ではレジスタに近い。
変数として使える1つ10進8桁の領域が1000個くらいあって、そこを使っていく感じになる。
アクセスの仕方は#数字である。
また、#1から#33まではアルファベットでもアクセスできる。</p>

<p>NCプログラムにおいて、#数値によるアクセスは変数代入参照とされているが、
現代の定義的には既に確保されている配列へのアクセスと見なす方が良い気がする。</p>

<h3 id="代入">代入</h3>

<p>X1.0、X#10 と #10=1.0 の2パターンある。
#への代入が面倒で、#だけでは代入なのか参照なのかわからない。
前処理で変数代入の場合letを先に入れる処理をする。</p>

<h2 id="前処理">前処理</h2>

<p>構文解析にかける前に全体にフィルタをかけ、
<em>アセンブリ言語のようなある種の中間言語を生成する。</em>
Golangのコードを生成する。</p>

<ol>
<li>メモリ確保</li>
<li>ポインタ宣言</li>
<li>コメントの削除</li>
<li>改行の変換</li>
<li>変数代入の変換</li>
</ol>

<p>これらについて述べる。</p>

<ol>
<li><p>メモリ確保<br />
アクセスされ得る変数を#1～#9999とし、これらに相当する配列を確保する。<br />
例)<br />
var mem = make([]Value,10000)</p></li>

<li><p>ポインタ宣言<br />
アルファベットで#33までの変数にアクセスできる機能を実装する。<br />
例)<br />
var X = &amp;mem[24]</p></li>

<li><p>コメントの削除<br />
単純に()でくくられた部分を削除する。</p></li>

<li><p>改行の変換<br />
これは段階を踏む。</p>

<ol>
<li>改行コードをLFに統一。</li>
<li>空行を削除。</li>
<li>改行コードを ブロック実行命令(run) に変換。<br />
例)<br />
G01X1\nX2\n → *G = 1; *X = 1; run(); *X = 2; run();</li>
</ol></li>

<li><p>変数代入の変換</p></li>
</ol>

<p>|元のNC|中間言語|
|X1.0 | X 1.0 |
|G01X1.0F2000| let G 1<br> let X 1.0<br> let F 2000|</p>

<ul>
<li>#10=10 →  let hash[10] 10</li>
<li>G01X#10 →</li>
<li>IF[#100EQ0]THEN#100=1 →</li>
</ul>

<h2 id="定数">定数</h2>

<p>基本的に10進8桁までとする。
先頭に0がついてもよい。</p>

<p>また、小数点の扱いが特別で、1と1.は別のものとして扱う。
1と0001は同じで、1.と1.0、00001.00000は同じ。</p>

<h2 id="io">IO</h2>

<h3 id="入力">入力</h3>

<p>NCデータの記述されたテキストファイル</p>

<p>基本UTF-8(no BOM)とするが、shift-jisにも対応する。</p>

<p>A. Okada が[2019/12/11 10:31]に更新</p>

<p>nc プログラム (通称 G code)
* テキストデータである。
* 文字コード : 規定無し (とりあえず UTF8 で、今後必要なら切り替え可にする)
* テキスト 1 行ごとに、1 回のまとまった動作を表す</p>

<p>※ 固有名詞を、通称 → 厳密な用語に書き換える可能性有</p>

<ul>
<li>最初の行は % である。</li>
<li>2番目の行は OXXXX (XXXX は整数) プログラム番号で、プログラムの id 番号のようなものである。</li>
<li>以降の行は &ldquo;ブロック&rdquo; の集まりが書いてある。</li>
<li>最後の行は % である。</li>
</ul>

<p>厳密に従わないプログラムもあるので、
* % は無視 (指令無し扱い)
* OXXXX は見つけた時点でプログラム番号扱い (=解析上無視してよい)
でもよい</p>

<p>ブロック
* NCプログラムは複数の指令で構成される。1個の指令をブロックという。
* ブロックは EOB コードで区切られる。制御装置上は ; で表示される。
* CAM の nc プログラム出力する場合は、EOB コードは改行文字である。</p>

<p>ブロックの構成
	アドレス = アルファベット1文字 ※特殊設定では存在するが通常は無視でよい
	ワード = アドレス + (スペースはさむ場合有) + 数値
	ブロック = {ワード}* (スペースはさむ場合有)
	ブロックが無い行はなにもしない</p>

<h3 id="出力">出力</h3>

<p>各座標の座標値、送り速度、などが記述された
csvファイルの予定</p>

<p>内容は拡張していく。</p>

</body>
</html>