# 仕様書

とりあえずFANUCの旋盤系向けに作る

## 予約語

基本的に実装していないのでエラーになる。
実装済みは、%()

独自の変数を定義することはできないので予約語という定義が正しいか微妙。
予約語以外の複数アルファベットはエラー。
独自マクロを実装する場合は予約語に追加で登録し実装する。

|      |     |      |       |      |      |
| ---  | --- | ---  | ---   | ---  | ---  |
| GOTO | IF  | THEN | WHILE | END  | ADD  |
| SUB  | MUL | DIV  | EQ    | NE   | LT   |
| LE   | GT  | GE   | AND   | OR   | XOR  |
| SIN  | COS | TAN  | ASIN  | ACOS | ATAN |
| +    | -   | *    | /     | =    | %    |
| (    | )   | [    | ]     | #    |      |
| A    | B   | C    | D     | E    | F    |
| G    | H   | I    | J     | K    | L    |
| M    | N   | O    | P     | Q    | R    |
| S    | T   | U    | V     | W    | X    |
| Y    | Z   |      |       |      |      |


## 変数

変数宣言が認められていない。
このため用意されている領域を使いまわすという意味ではレジスタに近い。
変数として使える1つ10進8桁の領域が1000個くらいあって、そこを使っていく感じになる。
アクセスの仕方は#数字である。
また、#1から#33まではアルファベットでもアクセスできる。

NCプログラムにおいて、#数値によるアクセスは変数代入参照とされているが、
現代の定義的には既に確保されている配列へのアクセスと見なす方が良い気がする。

### 代入
X1.0、X#10 と #10=1.0 の2パターンある。
\#への代入が面倒で、#だけでは代入なのか参照なのかわからない。
前処理で変数代入の場合letを先に入れる処理をする。


## 前処理
構文解析にかける前に全体にフィルタをかけ、
_アセンブリ言語のようなある種の中間言語を生成する。_
Golangのコードを生成する。

1. メモリ確保
1. ポインタ宣言
1. コメントの削除
1. 改行の変換
1. 変数代入の変換

これらについて述べる。

1. メモリ確保  
アクセスされ得る変数を#1～#9999とし、これらに相当する配列を確保する。  
	例)  
	var mem = make([]Value,10000)

1. ポインタ宣言  
アルファベットで#33までの変数にアクセスできる機能を実装する。  
	例)  
	var X = &mem[24]

1. コメントの削除  
単純に()でくくられた部分を削除する。

1. 改行の変換  
これは段階を踏む。  
	1. 改行コードをLFに統一。
	1. 空行を削除。
	1. 改行コードを ブロック実行命令(run) に変換。  
		例)  
		G01X1\nX2\n → *G = 1; *X = 1; run(); *X = 2; run();

1. 変数代入の変換


|元のNC|中間言語|
|X1.0 | X 1.0 |
|G01X1.0F2000| let G 1<br> let X 1.0<br> let F 2000|

* #10=10 →  let hash[10] 10
* G01X#10 → 
* IF[#100EQ0]THEN#100=1 → 

## 定数

基本的に10進8桁までとする。
先頭に0がついてもよい。

また、小数点の扱いが特別で、1と1.は別のものとして扱う。
1と0001は同じで、1.と1.0、00001.00000は同じ。


## IO

### 入力
NCデータの記述されたテキストファイル

基本UTF-8(no BOM)とするが、shift-jisにも対応する。

A. Okada が[2019/12/11 10:31]に更新

nc プログラム (通称 G code)
* テキストデータである。
* 文字コード : 規定無し (とりあえず UTF8 で、今後必要なら切り替え可にする)
* テキスト 1 行ごとに、1 回のまとまった動作を表す

※ 固有名詞を、通称 → 厳密な用語に書き換える可能性有

* 最初の行は % である。
* 2番目の行は OXXXX (XXXX は整数) プログラム番号で、プログラムの id 番号のようなものである。
* 以降の行は "ブロック" の集まりが書いてある。
* 最後の行は % である。

厳密に従わないプログラムもあるので、
* % は無視 (指令無し扱い)
* OXXXX は見つけた時点でプログラム番号扱い (=解析上無視してよい)
でもよい

ブロック
* NCプログラムは複数の指令で構成される。1個の指令をブロックという。
* ブロックは EOB コードで区切られる。制御装置上は ; で表示される。
* CAM の nc プログラム出力する場合は、EOB コードは改行文字である。

ブロックの構成
	アドレス = アルファベット1文字 ※特殊設定では存在するが通常は無視でよい
	ワード = アドレス + (スペースはさむ場合有) + 数値
	ブロック = {ワード}* (スペースはさむ場合有)
	ブロックが無い行はなにもしない

### 出力
各座標の座標値、送り速度、などが記述された
csvファイルの予定

内容は拡張していく。

## 
